# Orders Service

Микросервис для приёма и выдачи данных о заказах: HTTP-API, простая веб-страница для пользователя, Consumer из Kafka и хранение в БД.

## Содержание
- [Описание проекта](#описание-проекта)
- [Архитектура](#архитектура)
  - [Модули](#модули)
  - [Структура](#структура)
  - [API](#api)
- [Стек и зависимости](#стек-и-зависимости)
- [Конфигурация](#конфигурация)
- [Развертывание и запуск](#развертывание-и-запуск)
- [Тестирование](#тестирование)
- [Кэш](#кэш)
- [Схема БД](#схема-бд)
- [Миграции БД](#миграции-бд)
- [Обработка ошибок и ретраи](#обработка-ошибок-и-ретраи)
- [Возможные улучшения](#возможные-улучшения)

---

## Описание проекта

Сервис предоставляет:
- HTTP-API для получения информации о заказе: `GET /orders/{id}` (кэш -> БД).
- Простую HTML-страницу для ручного ввода `order_id` и просмотра данных.
- Consumer, который читает новые заказы из Kafka и сохраняет их в БД.
- Тесты для всех модулей с использованием testify и моков.
- Визуализацию покрытия тестами в файле `index.html`.

---

## Архитектура

### Модули

#### HTTP-сервер
Обрабатывает запросы к API и отдаёт HTML для `/`.

#### Web UI
Статическая страница на `/` с формой поиска по `order_id`. Доступна по порту, указанному в `.env` (по умолчанию `8081`).

#### Consumer (Kafka -> DB)
Читает сообщения с заказами из Kafka и сохраняет/обновляет записи в БД.

#### Producer
Вспомогательный модуль для генерации случайных заказов и отправки их в Kafka. Запускается через `go run producer/main.go`.

#### PostgreSQL
Хранит информацию о заказах и связанных сущностях.

#### Тестовый модуль
Модульные тесты для проверки сквозной работы всех модулей.

### API

#### `GET /orders/{id}`
**Описание:** получить заказ по идентификатору.  
**Источник данных:** Cache -> DB (fallback).

**Ответы:**
- `200 OK` - JSON заказа
- `404 Not Found` - заказ не найден
- `500 Internal Server Error` - ошибка сервера

#### `GET /`
**Описание:** HTML-форма для ввода `order_id`.  
**Ответы:** `200 OK` - HTML.

---

## Стек и зависимости
- Язык: Go
- Брокер сообщений: Apache Kafka
- Хранилище: PostgreSQL
- Кэш: in-memory с поддержкой LRU и инвалидацией
- Контейнеризация: Docker + docker-compose
- Тестирование: testify с моками
- Вспомогательный producer: Go
- Линтер - Trunk

---

### Структура

```
.
├── cmd
│ └── main.go
├── coverage.out
├── cover.txt
├── docker-compose.yaml
├── Dockerfile
├── index.html - визуализация покрытия тестами
├── internal
│ ├── api
│ │ ├── http_test.go
│ │ ├── server.go
│ │ └── web
│ │ └── index.html
│ ├── consumer
│ │ └── consumer.go
│ ├── model
│ │ └── order.go
│ ├── repository
│ │ ├── cache-repository.go
│ │ └── db-repository.go
│ └── service
│ └── service.go
├── migrations
│ ├── 000001_create_tables.down.sql
│ └── 000001_create_tables.up.sql
├── producer
│ ├── main.go
│ └── model
│ └── order.go
├── README.md
├── script.sh
├── structure.txt
└── tests
├── cache_test.go
├── consumer_test.go
├── db_test.go
├── service_test.go
├── test.go
└── validation_test.go
```

---

## Конфигурация

Прикреплен `.env.example` с настройками подключения к БД, порта сервиса и Kafka.

---

## Развертывание и запуск

> Локальный запуск через `docker compose up`.

- Сервис будет доступен по `localhost:8081` или порту, указанному в `.env`.
- HTML-форма поиска заказов доступна по `/`.
- Producer запускается отдельно через `go run producer/main.go` и позволяет отправлять случайные заказы в Kafka для тестирования работы Consumer.

---

## Тестирование

- Модульные тесты для всех модулей с использованием testify.
- Моки позволяют тестировать Consumer, DB, сервис и кэш без реального подключения к Kafka или БД.
- Визуализация покрытия тестами хранится в `index.html`.

---

## Кэш

- **Стратегия:** Cache-Aside (read-through) - сначала кэш, при промахе запрос к БД и последующая запись в кэш.
- **Механизм:** in-memory cache с LRU и поддержкой инвалидации.
- **Ключ:** `order:{id}`.

---

## Схема БД

- **orders** - корневая сущность заказа. `order_uid UUID PRIMARY KEY`.
- **deliveries** - адрес и контакты доставки. 1 запись на заказ.
- **payments** - платёжные атрибуты. 1 запись на заказ.
- **items** - товарные позиции заказа. Много записей на заказ.


### Ключевые поля

| Таблица     | PK                        | FK                                   | Уникальность                         |
|-------------|---------------------------|--------------------------------------|--------------------------------------|
| `orders`    | `order_uid` (UUID)        | -                                    | -                                    |
| `deliveries`| `delivery_id` (SERIAL)    | `order_uid` -> `orders(order_uid)`    | `UNIQUE (order_uid)`                 |
| `payments`  | `payment_id` (SERIAL)     | `order_uid` -> `orders(order_uid)`    | `UNIQUE (order_uid)`                 |
| `items`     | `item_id` (SERIAL)        | `order_uid` -> `orders(order_uid)`    | `UNIQUE (order_uid, chrt_id)`        |






## Возможные улучшения

- **Observability:** Prometheus метрики, slog для структурированного логирования.
- **Интеграционное тестирование:** поднятие БД и Kafka внутри теста.
- **DLQ:** очередь для сообщений, которые не удалось обработать Consumer.
- **Swagger** - Документация API
