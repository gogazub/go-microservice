# Orders Service

Микросервис для приёма и выдачи данных о заказах: HTTP-API, простая веб-страница для пользователя, Consumer из Kafka и хранение в БД.

## Содержание
- [Описание проекта](#описание-проекта)
- [Архитектура](#архитектура)
  - [Модули](#модули)
  - [Структура](#структура)
  - [API](#api)
- [Стек и зависимости](#стек-и-зависимости)
- [Конфигурация](#конфигурация)
- [Развертывание и запуск](#развертывание-и-запуск)
- [Тестирование](#тестирование)
- [Кэш](#кэш)
- [Схема БД](#схема-бд)
- [Миграции БД](#миграции-бд)
- [Обработка ошибок и ретраи](#обработка-ошибок-и-ретраи)

---

## Описание проекта

Сервис предоставляет:
- HTTP-API для получения информации о заказе: `GET /orders/{id}` (кэш -> БД).
- Простую HTML-страницу для ручного ввода `order_id` и просмотра данных.
- Consumer, который читает новые заказы из Kafka и сохраняет их в БД.
- Интеграционные тесты для проверки сквозной работы модулей.

---

## Архитектура

### Модули

#### HTTP-сервер
Обрабатывает запросы к API и отдаёт HTML для `/`.

#### Web UI
Статическая страница на `/` с формой поиска по `order_id`.

#### Consumer (Kafka -> DB)
Читает сообщения с заказами из Kafka и сохраняет/обновляет записи в БД.

#### PostgreSQL
Хранит информацию о заказах и связанных сущностях.

#### Тестовый модуль
Интеграционные тесты для проверки сценариев end-to-end.

### API

#### `GET /orders/{id}`
**Описание:** получить заказ по идентификатору.  
**Источник данных:** Cache -> DB (fallback).

**Ответы:**
- `200 OK` - JSON заказа
- `404 Not Found` - заказ не найден
- `500 Internal Server Error` - ошибка сервера

#### `GET /`
**Описание:** HTML-форма для ввода `order_id`.  
**Ответы:** `200 OK` - HTML.

---

## Стек и зависимости
- Язык: Go
- Брокер сообщений: Apache Kafka
- Хранилище: PostgreSQL
- Кэш: in-memory
- Контейнеризация: Docker + docker-compose
- Документация API: Swagger / OpenAPI *(будет добавлено позже)*
- Тестирование: gofakeit/faker *(будет интегрировано позже)*

---

### Структура
```
.
├── cmd
│   └── server
│       └── main.go
├── docker-compose.yaml
├── internal
│   ├── orders
│   │   ├── cache-repository.go
│   │   ├── model.go
│   │   ├── repository.go
│   │   └── service.go
│   └── server
│       ├── consumer
│       │   └── consumer.go
│       ├── server.go
│       └── web
│           └── index.html
├── migrations
│   ├── 000001_create_tables.down.sql
│   └── 000001_create_tables.up.sql
├── README.md
└── test_producer
    └── tests.py
```


## Конфигурация
Будет добавлено позже.

> Планируется приложить `.env.example` с ключевыми переменными окружения.

---

## Развертывание и запуск
Будет добавлено позже.

> Предполагается сценарий локального запуска через `docker compose up` и отдельные команды для модулей.

---

## Тестирование
Будет добавлено позже.

---

## Кэш
- **Стратегия:** Cache-Aside (read-through) - сначала кэш, при промахе запрос к БД и последующая запись в кэш.  
- **Ключ:** `order:{id}`.

---


## Обработка ошибок и ретраи
Будет добавлено позже.



## Схема БД

- **orders** - корневая сущность заказа. `order_uid UUID PRIMARY KEY`.
- **deliveries** - адрес и контакты доставки. 1 запись на заказ.
- **payments** - платёжные атрибуты. 1 запись на заказ.
- **items** - товарные позиции заказа. Много записей на заказ.

> Поведение FK: по умолчанию `NO ACTION` (удаление `orders` запрещено при наличии связанных записей).

### Ключевые поля

| Таблица     | PK                        | FK                                   | Уникальность                         |
|-------------|---------------------------|--------------------------------------|--------------------------------------|
| `orders`    | `order_uid` (UUID)        | -                                    | -                                    |
| `deliveries`| `delivery_id` (SERIAL)    | `order_uid` -> `orders(order_uid)`    | `UNIQUE (order_uid)`                 |
| `payments`  | `payment_id` (SERIAL)     | `order_uid` -> `orders(order_uid)`    | `UNIQUE (order_uid)`                 |
| `items`     | `item_id` (SERIAL)        | `order_uid` -> `orders(order_uid)`    | `UNIQUE (order_uid, chrt_id)`        |

---